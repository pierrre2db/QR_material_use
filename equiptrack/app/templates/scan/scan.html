{% extends "base.html" %}

{% block title %}Scanner un équipement - {{ super() }}{% endblock %}

{% block extra_css %}
<style>
    #preview {
        width: 100%;
        max-width: 500px;
        height: 400px;
        margin: 0 auto;
        background-color: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 0.25rem;
        position: relative;
        overflow: hidden;
    }
    
    #preview video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    #scan-region {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 70%;
        height: 70%;
        border: 2px solid #0d6efd;
        border-radius: 0.5rem;
        box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.5);
    }
    
    .camera-selector {
        max-width: 500px;
        margin: 0 auto 1rem;
    }
    
    .manual-input {
        max-width: 500px;
        margin: 2rem auto 0;
        padding-top: 2rem;
        border-top: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 text-center">
        <h1 class="mb-4">
            <i class="bi bi-upc-scan"></i> Scanner un équipement
        </h1>
        
        <div class="camera-selector mb-3">
            <label for="camera-select" class="form-label">Caméra</label>
            <select class="form-select" id="camera-select">
                <option value="">Chargement des caméras...</option>
            </select>
        </div>
        
        <div id="preview" class="mb-3">
            <div id="scan-region"></div>
            <video id="scanner" playsinline></video>
        </div>
        
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i> Placez le QR code dans la zone de scan
        </div>
        
        <div class="manual-input">
            <p class="text-muted">Ou entrez manuellement le code :</p>
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="manual-code" 
                       placeholder="Code QR (6 caractères)" maxlength="6" 
                       pattern="[A-Z0-9]{6}" title="6 caractères alphanumériques">
                <button class="btn btn-primary" type="button" id="manual-submit">
                    <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de résultat -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">Résultat du scan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body" id="resultModalBody">
                <!-- Contenu dynamique -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <a href="#" class="btn btn-primary" id="viewEquipmentBtn">
                    <i class="bi bi-eye"></i> Voir la fiche
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('scanner');
    const cameraSelect = document.getElementById('camera-select');
    const manualCode = document.getElementById('manual-code');
    const manualSubmit = document.getElementById('manual-submit');
    let stream = null;
    let scanning = false;
    
    // Éléments du modal
    const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
    const resultModalTitle = document.getElementById('resultModalTitle');
    const resultModalBody = document.getElementById('resultModalBody');
    const viewEquipmentBtn = document.getElementById('viewEquipmentBtn');
    
    // Charger les caméras disponibles
    async function loadCameras() {
        try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            
            cameraSelect.innerHTML = '';
            
            if (videoDevices.length === 0) {
                cameraSelect.innerHTML = '<option value="">Aucune caméra trouvée</option>';
                return;
            }
            
            videoDevices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Caméra ${index + 1}`;
                cameraSelect.appendChild(option);
            });
            
            // Démarrer avec la caméra arrière par défaut si disponible
            const backCamera = videoDevices.find(device => 
                device.label.toLowerCase().includes('back') || 
                device.label.toLowerCase().includes('arrière')
            );
            
            if (backCamera) {
                cameraSelect.value = backCamera.deviceId;
            }
            
            startCamera(cameraSelect.value);
            
        } catch (err) {
            console.error('Erreur lors du chargement des caméras:', err);
            showError('Impossible d\'accéder aux caméras. Vérifiez les permissions.');
        }
    }
    
    // Démarrer la caméra
    async function startCamera(deviceId) {
        stopCamera();
        
        const constraints = {
            video: {
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };
        
        if (deviceId) {
            constraints.video.deviceId = { exact: deviceId };
        }
        
        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            video.play();
            scanning = true;
            scanQRCode();
        } catch (err) {
            console.error('Erreur lors du démarrage de la caméra:', err);
            showError('Impossible de démarrer la caméra. Vérifiez les permissions.');
        }
    }
    
    // Arrêter la caméra
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        scanning = false;
    }
    
    // Scanner le QR code
    function scanQRCode() {
        if (!scanning) return;
        
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: 'dontInvert'
        });
        
        if (code) {
            handleScannedCode(code.data);
        } else {
            requestAnimationFrame(scanQRCode);
        }
    }
    
    // Gérer le code scanné
    function handleScannedCode(code) {
        // Vérifier le format du code
        if (!/^[A-Z0-9]{6}$/.test(code)) {
            showError('Code QR invalide');
            setTimeout(() => requestAnimationFrame(scanQRCode), 1000);
            return;
        }
        
        // Arrêter le scan
        scanning = false;
        
        // Vérifier si l'équipement existe
        fetch(`/api/equipment/${code}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Équipement non trouvé');
                }
                return response.json();
            })
            .then(equipment => {
                // Afficher les détails dans le modal
                resultModalTitle.textContent = equipment.name;
                resultModalBody.innerHTML = `
                    <p><strong>Code QR:</strong> ${equipment.qr_code}</p>
                    <p><strong>Statut:</strong> 
                        <span class="badge ${getStatusBadgeClass(equipment.status)}">
                            ${equipment.status}
                        </span>
                    </p>
                    ${equipment.description ? `<p><strong>Description:</strong> ${equipment.description}</p>` : ''}
                `;
                
                // Mettre à jour le lien vers la fiche
                viewEquipmentBtn.href = `/equipment/${equipment.qr_code}`;
                
                // Afficher le modal
                resultModal.show();
                
                // Enregistrer le scan
                return fetch('/api/usage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        qr_code: equipment.qr_code,
                        type: 'scan',
                        user: 'Utilisateur actuel', // À remplacer par l'utilisateur connecté
                        notes: 'Scan via l\'application web'
                    })
                });
            })
            .catch(error => {
                console.error('Erreur:', error);
                showError('Équipement non trouvé ou erreur de connexion');
                setTimeout(() => {
                    scanning = true;
                    scanQRCode();
                }, 2000);
            });
    }
    
    // Afficher une erreur
    function showError(message) {
        resultModalTitle.textContent = 'Erreur';
        resultModalBody.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> ${message}
            </div>
        `;
        viewEquipmentBtn.style.display = 'none';
        resultModal.show();
    }
    
    // Obtenir la classe du badge de statut
    function getStatusBadgeClass(status) {
        switch (status) {
            case 'disponible': return 'bg-success';
            case 'maintenance': return 'bg-warning text-dark';
            case 'hors_service': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    
    // Événements
    cameraSelect.addEventListener('change', () => {
        if (cameraSelect.value) {
            startCamera(cameraSelect.value);
        }
    });
    
    manualSubmit.addEventListener('click', () => {
        const code = manualCode.value.trim().toUpperCase();
        if (/^[A-Z0-9]{6}$/.test(code)) {
            handleScannedCode(code);
        } else {
            showError('Le code doit contenir exactement 6 caractères alphanumériques');
        }
    });
    
    manualCode.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            manualSubmit.click();
        }
    });
    
    // Redémarrer le scan quand le modal est fermé
    document.getElementById('resultModal').addEventListener('hidden.bs.modal', () => {
        if (stream) {
            scanning = true;
            scanQRCode();
        }
    });
    
    // Démarrer
    loadCameras();
    
    // Nettoyer à la fermeture
    window.addEventListener('beforeunload', () => {
        stopCamera();
    });
});
</script>
{% endblock %}
